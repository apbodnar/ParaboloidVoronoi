
<html>

<head>
<title>Voronoi</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
<script type="text/javascript" src="webgl-utils.js"></script>

<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
	
	uniform float tick;  
	
	varying vec3 color;
	varying vec4 rc;
	
    void main(void) {
		//gl_FragColor = vec4(abs(color),1);
		gl_FragColor = rc;
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
	attribute vec4 aVertexTrans;
	
	varying vec3 color;
	varying vec4 rc;
	
	uniform float tick;
	uniform int count;
	float zscale = 16.0;
	//eye-ballin' it
	float parabolZ(vec2 p){
		return (p.x*p.x+p.y*p.y)/zscale;
	}
	
	vec3 gradient(vec2 p){
		float r = sqrt(parabolZ(p));
		//return vec3(2.0*p.x,2.0*p.y,1.0/parabolZ(p))/3.0;
		return vec3(2.0*p.x,2.0*p.y,1.0/(2.0*r))/zscale;
	}
	
	float getAngleX(vec3 a){
		vec3 a1 = vec3(a.x,0.0,a.z);
		vec3 b1 = vec3(0.0,0.0,1.0);
		return atan(length(cross(a1,b1)),a.z);
	}
	
	float getAngleY(vec3 a){
		vec3 a1 = vec3(0.0,a.yz);
		vec3 b1 = vec3(0.0,0.0,1.0);
		return atan(length(cross(a1,b1)),a.z);
	}
	
	float rand(vec2 co){
		return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
	}
	
	mat4 rX(float a) {
		float c = cos(a);
		float s = sin(a);
		return	mat4( 1.0,	0.0,	0.0,	0.0,
					0.0,	c,		-s,		0.0,
					0.0,	s,		c,		0.0,
					0.0,	0.0,	0.0,	1.0);
	}
	
	mat4 rY(float a) {
		float c = cos(a);
		float s = sin(a);
		return	mat4( c,	0.0,	s,		0.0,
					0.0,	1.0,	0.0,	0.0,
					-s,		0.0,	c,		0.0,
					0.0,	0.0,	0.0,	1.0);
	}
	
	mat4 rZ(float a) {
		float c = cos(a);
		float s = sin(a);
		return	mat4(c,		-s,		0.0,	0.0,
					s,		c,		0.0,	0.0,
					0.0,	0.0,	1.0,	0.0,
					0.0,	0.0,	0.0,	1.0);
	}
	
    void main(void) {
		float PI = 3.14159265358979323846264;
		rc = (vec4(rand(aVertexTrans.xy),rand(aVertexTrans.xy+1.0),rand(aVertexTrans.xy-1.0),1));
		vec4 rTrans = aVertexTrans * rZ(cos(600.0*length(aVertexTrans))*tick/200.0);
		vec3 grad = -normalize(gradient(rTrans.xy));
		color = grad;
		float ax = getAngleX(grad);
		float ay = getAngleY(grad);
		mat4 r = rX(ay*sign(rTrans.y));
		r *= rY(ax*sign(rTrans.x));
		vec4 vTrans = vec4(rTrans.xy,-parabolZ(rTrans.xy),0);//* rZ(tick/100.0);
        gl_Position = vec4((vec4(40.0/sqrt(float(count))*aVertexPosition, 0.0) * r + vTrans).xyz,1.0);
    }
</script>

<script src="voronoi.js" type="text/javascript"></script>
</head>


<body onload="webGLStart();">
    <canvas id="LICcanvas" style="border: none;" width="800" height="800"></canvas>
</body>

</html>
